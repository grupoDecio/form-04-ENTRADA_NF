function createDataset(fields, constraints, sortFields) { log.info("Digte Public Form - @@@ Inicio Dataset ds_dpf_getForm.js"); var dataset = DatasetBuilder.newDataset(); var idFormulario = ""; var codigoFormularioPublico = ""; var userLocale = 'pt_BR'; var cDataset = ""; var permitirAnexo = ""; var permitirMsg = ""; try { if (constraints != null) { for (var i = 0; i < constraints.length; i++) { if (constraints[i].fieldName == "co" && constraints[i].initialValue != "") { codigoFormularioPublico = constraints[i].initialValue; } else if (constraints[i].fieldName == "userLocale" && constraints[i].initialValue != "") { userLocale = constraints[i].initialValue; } else if (constraints[i].fieldName == "cDataset" && constraints[i].initialValue != "") { cDataset = constraints[i].initialValue; } } if (cDataset == "" || cDataset == null){ var cCodForm = DatasetFactory.createConstraint("codigoFormularioPublico", codigoFormularioPublico, codigoFormularioPublico, ConstraintType.MUST); var dsConfig = DatasetFactory.getDataset("dpf_configuracoes", ["datasetFormulario", "permitirAnexo", "permitirMsg", "idFormulario"], [cCodForm], null); if (dsConfig != undefined && dsConfig != null && dsConfig.rowsCount > 0) { dsName = dsConfig.getValue(0, "datasetFormulario") + ""; permitirAnexo = dsConfig.getValue(0, "permitirAnexo") + ""; permitirMsg = dsConfig.getValue(0, "permitirMsg") + ""; idFormulario = dsConfig.getValue(0, "idFormulario") + ""; } } else { log.info("Digte Public Form - @@ Buscando por cDataset - Git 29/03/2019 - cDataset: " + cDataset); } var documentUrl = fluigAPI.getDocumentService().getDownloadURL(parseInt(idFormulario)); var url = null; log.info('Digte Public Form - chamada rest: ' + documentUrl); url = new java.net.URL(documentUrl); var connection = url.openConnection(); log.info('Digte Public Form - conexao realizada'); connection.setRequestMethod("GET"); connection.setRequestProperty("Accept", "application/json"); var input = new java.io.BufferedReader(new java.io.InputStreamReader(connection.getInputStream())); var responseString = ""; var outputString = ""; var builder = new java.lang.StringBuilder(); while ((responseString = input.readLine()) != null) { builder.append(responseString); } outputString = builder.toString(); if (input != null) { input.close(); } if (connection != null) { connection.disconnect(); } dataset.addColumn("documentId"); dataset.addColumn("documentUrl"); dataset.addColumn("htmlContent"); dataset.addColumn("permitirAnexo"); dataset.addColumn("permitirMsg"); dataset.addRow([idFormulario, documentUrl, outputString,permitirAnexo,permitirMsg]); return dataset; } else { dataset.addColumn("message"); dataset.addRow([objLocale['form-nao-encontrado-' + userLocale]]); return dataset; } } catch (e) { if (input != null) { input.close(); } if (connection != null) { connection.disconnect(); } log.info("Digte Public Form - @@ Catch exceção ao executar getForm " + e); dataset.addColumn("message"); dataset.addRow([objLocale['form-catch-' + userLocale] + ' ' + e]); return dataset; } log.info("Digte Public Form - @@@ Fim Dataset ds_dpf_getForm.js"); return dataset; } var objLocale = { 'form-nao-encontrado-pt_BR': '@@ Formulário não encontrado. Verifique se o id ou nome do Dataset do formulário está correto ', 'form-nao-encontrado-en_US': '@@ Form not found. Verify if the id or dataset name is corret', 'form-nao-encontrado-es': '@@ Formulario no encontrado. Verifique se el id ou nome do Dataset do formulario esta correto', 'form-catch-pt_BR': '@@ Catch exceção ao executar getForm. Verifique se o id ou nome do Dataset do formulário está correto', 'form-catch-en_US': '@@ Catch exception when executing getForm. Verify if the id or dataset name is corret', 'form-catch-es': '@@ Catch excepción al ejecutar getForm. Verifique se el id ou nome do Dataset do formulario esta correto' }