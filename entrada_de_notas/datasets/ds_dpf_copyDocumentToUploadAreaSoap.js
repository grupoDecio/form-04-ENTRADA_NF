function createDataset(fields, constraints, sortFields) { log.info("Digte Public Form - @@@ Inicio Dataset ds_dpf_copyDocumentToUploadAreaSoap.js"); var dataset = DatasetBuilder.newDataset(); var user = ""; var password = ""; var company = ""; var serverUrl = ""; var documentId = ""; var version = ""; var colleagueId = ""; var connection = null; var isr = null; var la = null; try { if (constraints != null) { for (var i = 0; i < constraints.length; i++) { if (constraints[i].fieldName == "user" && constraints[i].initialValue != "") { user = constraints[i].initialValue; } else if (constraints[i].fieldName == "password" && constraints[i].initialValue != "") { password = constraints[i].initialValue; } else if (constraints[i].fieldName == "company" && constraints[i].initialValue != "") { company = constraints[i].initialValue; } else if (constraints[i].fieldName == "serverUrl" && constraints[i].initialValue != "") { serverUrl = constraints[i].initialValue; } else if (constraints[i].fieldName == "documentId" && constraints[i].initialValue != "") { documentId = constraints[i].initialValue; } else if (constraints[i].fieldName == "version" && constraints[i].initialValue != "") { version = constraints[i].initialValue; } else if (constraints[i].fieldName == "colleagueId" && constraints[i].initialValue != "") { colleagueId = constraints[i].initialValue; } } var message = ""; if (user == "") { message = "@@ Parametro 'user' não informado."; } else if (password == "") { message = "@@ Parametro 'password' não informado."; } else if (company == "") { message = "@@ Parametro 'company' não informado."; } else if (serverUrl == "") { message = "@@ Parametro 'serverUrl' não informado."; } else if (documentId == "") { message = "@@ Parametro 'documentId' não informado."; } else if (version == "") { message = "@@ Parametro 'version' não informado."; } else if (colleagueId == "") { message = "@@ Parametro 'colleagueId' não informado."; } if (message != "") { dataset.addColumn("message"); dataset.addRow([message]); return dataset; } log.info('Digte Public Form - chamada rest: ' + serverUrl + '/webdesk/ECMDocumentService?wsdl'); var url = new java.net.URL(serverUrl + "/webdesk/ECMDocumentService?wsdl"); connection = url.openConnection(); connection.setDoOutput(true); var postData = new java.lang.StringBuilder(); postData.append('<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:ws="http://ws.workflow.ecm.technology.totvs.com/">'); postData.append("<soapenv:Header/>"); postData.append("<soapenv:Body>"); postData.append("<ws:copyDocumentToUploadArea>"); postData.append("<user>" + user + "</user>"); postData.append("<password>" + password + "</password>"); postData.append("<companyId>" + company + "</companyId>"); postData.append("<documentId>" + documentId + "</documentId>"); postData.append("<version>" + version + "</version>"); postData.append("<colleagueId>" + colleagueId + "</colleagueId>"); postData.append("</ws:copyDocumentToUploadArea>"); postData.append("</soapenv:Body>"); postData.append("</soapenv:Envelope>"); var mensagem = new java.lang.String(postData); var posIni = mensagem.indexOf("<password>") + 10; var posFim = mensagem.indexOf("</password>"); var senha = mensagem.substring(posIni,posFim); mensagem = mensagem.replace("<password>" + senha + "</password>", "<password>************</password>" ); log.info('Digte Public Form - xml: >>>>>>> '+mensagem); connection.setRequestMethod("POST"); var SOAPAction = "copyDocumentToUploadArea"; connection.setRequestProperty("Content-Type", "text/xml; charset=utf-8"); connection.setRequestProperty("SOAPAction", SOAPAction); var os = connection.getOutputStream(); os.write(postData.toString().getBytes()); os.flush(); var retorno = connection.getResponseCode(); isr = new java.io.InputStreamReader(connection.getInputStream()); la = new java.io.BufferedReader(isr); var responseString = ""; var outputString = ""; while ((responseString = la.readLine()) != null) { outputString = outputString + responseString; } var dbf = javax.xml.parsers.DocumentBuilderFactory.newInstance(); var db = dbf.newDocumentBuilder(); var stringReader = new java.io.StringReader(outputString); var xml = db.parse( new org.xml.sax.InputSource(stringReader)); var result = xml.getElementsByTagName("result"); var items = result.item(0).getChildNodes(); var itemsLength = items.getLength(); stringReader.close(); if (itemsLength > 0) { dataset.addColumn("fileName"); for (var i = 0; i < itemsLength; i++) { var fileName = items.item(i).getTextContent().trim(); dataset.addRow([fileName]); } return dataset; } else { dataset.addColumn("message"); dataset.addRow(["@@ Falha ao consultar Thread."]); return dataset; } } else { dataset.addColumn("message"); dataset.addRow(["@@ Não foram informados os parâmetros."]); return dataset; } } catch (e) { log.info("Digte Public Form - @@ Catch exceção ao executar startProcess " + e); dataset.addColumn("message"); dataset.addRow(["@@ Catch exceção ao executar startProcess " + e]); return dataset; } finally { if(isr != null) isr.close(); if(la != null) la.close(); if(connection != null) connection.disconnect(); } log.info("Digte Public Form - @@@ Fim Dataset ds_dpf_copyDocumentToUploadAreaSoap.js"); return dataset; }