function createDataset(fields, constraints, sortFields) { log.info("Digte Public Form - @@@ Inicio Dataset ds_dpf_addMessage.js"); var dataset = DatasetBuilder.newDataset(); var user = ""; var password = ""; var company = getValue("WKCompany"); var processInstanceId = ""; var userPost = ""; var threadSequence = ""; var observacao = ""; var serverUrl = ""; var stateSequence = ""; var codigoFormularioPublico = ""; var userLocale = 'pt_BR'; var isIdentityEnabled = ""; var currentUser = getValue("WKUser"); if (constraints != null) { for (var i = 0; i < constraints.length; i++) { if (constraints[i].fieldName == "su" && constraints[i].initialValue != "") { serverUrl = constraints[i].initialValue; } else if (constraints[i].fieldName == "p" && constraints[i].initialValue != "") { processInstanceId = constraints[i].initialValue; } else if (constraints[i].fieldName == "obs" && constraints[i].initialValue != "") { observacao = constraints[i].initialValue; } else if (constraints[i].fieldName == "co" && constraints[i].initialValue != "") { codigoFormularioPublico = constraints[i].initialValue; } else if (constraints[i].fieldName == "userLocale" && constraints[i].initialValue != "") { userLocale = constraints[i].initialValue; } else if (constraints[i].fieldName == "isIdentityEnabled" && constraints[i].initialValue != "") { isIdentityEnabled = constraints[i].initialValue; } } /* gera codigo encriptado da solicitação */ var cString = DatasetFactory.createConstraint("stringValue", processInstanceId, processInstanceId, ConstraintType.MUST); var dsDecode = DatasetFactory.getDataset("ds_dpf_converter_string_to_base64", null, [cString], null); if (dsDecode != undefined && dsDecode != null && dsDecode.rowsCount > 0) { processInstanceId = dsDecode.getValue(0, "decoded"); } var cCodForm = DatasetFactory.createConstraint("codigoFormularioPublico", codigoFormularioPublico, codigoFormularioPublico, ConstraintType.MUST); var dsConfig = DatasetFactory.getDataset("dpf_configuracoes", null, [cCodForm], null); if (dsConfig != undefined && dsConfig != null && dsConfig.rowsCount > 0) { userPost = currentUser + ""; var valor = dsConfig.getValue(0, "senhaStartProcess") + ""; var str = new java.lang.String(valor); var asBytes = java.util.Base64.getDecoder().decode(str); var password = new java.lang.String(asBytes, "utf-8"); } user = dsConfig.getValue(0, "userStartProcessLogin") + ""; stateSequence = getState(user, password, company, processInstanceId, serverUrl, userPost); threadSequence = getThreadSequence(user, password, company, processInstanceId, stateSequence, serverUrl); if (threadSequence == -1) { dataset.addColumn("message"); dataset.addRow([objLocale['dsSetTasksCommentsSoap-message-falha-' + userLocale]]); return dataset; } /* PREPARANDO PARAMETROS PARA CHAMADA DO WEBSERVICE */ var cUser = DatasetFactory.createConstraint("user", user, "", ConstraintType.MUST), cPass = DatasetFactory.createConstraint("password", password, "", ConstraintType.MUST), cComp = DatasetFactory.createConstraint("company", company, "", ConstraintType.MUST), cPInstance = DatasetFactory.createConstraint("processInstanceId", processInstanceId, "", ConstraintType.MUST), cUserP = DatasetFactory.createConstraint("userPost", userPost, "", ConstraintType.MUST), cThread = DatasetFactory.createConstraint("threadSequence", threadSequence, "", ConstraintType.MUST), cObs = DatasetFactory.createConstraint("observacao", observacao, "", ConstraintType.MUST), cURL = DatasetFactory.createConstraint("serverUrl", serverUrl, "", ConstraintType.MUST), cLocale = DatasetFactory.createConstraint("userLocale", userLocale, "", ConstraintType.MUST), constr = new Array(cUser, cPass, cComp, cPInstance, cUserP, cThread, cObs, cURL, cLocale); var dsSetTasksCommentsSoap = DatasetFactory.getDataset("ds_dpf_setTasksCommentsSoap", null, constr, null); if (dsSetTasksCommentsSoap != null && dsSetTasksCommentsSoap != undefined && dsSetTasksCommentsSoap.rowsCount > 0) { if (dsSetTasksCommentsSoap.getValue(0, "result") != undefined) { if (dsSetTasksCommentsSoap.getValue(0, "result") == "OK") { dataset.addColumn("message"); dataset.addRow([objLocale['dsSetTasksCommentsSoap-message-sucesso-' + userLocale]]); return dataset; } else { dataset.addColumn("message"); dataset.addRow([objLocale['dsSetTasksCommentsSoap-message-falha-' + userLocale] + "(" + dsSetTasksCommentsSoap.getValue(0, "result") +")"]); return dataset; } } } } log.info("Digte Public Form - @@@ Fim Dataset ds_dpf_addMessage.js"); return dataset; } function getThreadSequence(user, password, company, processInstanceId, stateSequence, serverUrl) { var cUser = DatasetFactory.createConstraint("user", user, "", ConstraintType.MUST), cPass = DatasetFactory.createConstraint("password", password, "", ConstraintType.MUST), cComp = DatasetFactory.createConstraint("company", company, "", ConstraintType.MUST), cPInstance = DatasetFactory.createConstraint("processInstanceId", processInstanceId, "", ConstraintType.MUST), cState = DatasetFactory.createConstraint("stateSequence", stateSequence, "", ConstraintType.MUST), cURL = DatasetFactory.createConstraint("serverUrl", serverUrl, "", ConstraintType.MUST), constr = new Array(cUser, cPass, cComp, cPInstance, cState, cURL); var dsGetActualThreadSoap = DatasetFactory.getDataset("ds_dpf_getActualThreadSoap", null, constr, null); if (dsGetActualThreadSoap != null && dsGetActualThreadSoap != undefined && dsGetActualThreadSoap.rowsCount > 0) { if (dsGetActualThreadSoap.getValue(0, "actualThread") != undefined) { return dsGetActualThreadSoap.getValue(0, "actualThread"); } else { return -1; } } } function getState(user, password, company, processInstanceId, serverUrl, userId) { var cUser = DatasetFactory.createConstraint("user", user, "", ConstraintType.MUST), cPass = DatasetFactory.createConstraint("password", password, "", ConstraintType.MUST), cComp = DatasetFactory.createConstraint("company", company, "", ConstraintType.MUST), cPInstance = DatasetFactory.createConstraint("processInstanceId", processInstanceId, "", ConstraintType.MUST), cUserId = DatasetFactory.createConstraint("userId", userId, "", ConstraintType.MUST), cURL = DatasetFactory.createConstraint("serverUrl", serverUrl, "", ConstraintType.MUST), constr = new Array(cUser, cPass, cComp, cPInstance, cUserId, cURL); var dsGetAllActiveStatesSoap = DatasetFactory.getDataset("ds_dpf_getAllActiveStatesSoap", null, constr, null); if (dsGetAllActiveStatesSoap != null && dsGetAllActiveStatesSoap != undefined && dsGetAllActiveStatesSoap.rowsCount > 0) { if (dsGetAllActiveStatesSoap.getValue(0, "state") != undefined) { return dsGetAllActiveStatesSoap.getValue(0, "state"); } else { return -1; } } } var objLocale = { 'dsSetTasksCommentsSoap-message-falha-pt_BR': 'Falha ao inserir comentário', 'dsSetTasksCommentsSoap-message-falha-en_US': 'Failed to insert comment', 'dsSetTasksCommentsSoap-message-falha-es': 'Error al insertar comentario', 'dsSetTasksCommentsSoap-message-sucesso-pt_BR': 'Comentário incluído com sucesso', 'dsSetTasksCommentsSoap-message-sucesso-en_US': 'Comment included successfully', 'dsSetTasksCommentsSoap-message-sucesso-es': 'Comentario incluido con éxito', }