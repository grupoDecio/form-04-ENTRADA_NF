function createDataset(fields, constraints, sortFields) { log.info("Digte Public Form - @@@ Inicio Dataset ds_dpf_getListaStatusProcAtiv.js"); var dataset = DatasetBuilder.newDataset(); var idProcesso = ""; var codigoFormularioPublico = ""; var jornada = ""; dataset.addColumn("codigoFormularioPublico"); dataset.addColumn("atividadeOrdem"); dataset.addColumn("atividadeId"); dataset.addColumn("resultadoAtividade"); dataset.addColumn("campo"); dataset.addColumn("jornadaOrdem"); if (constraints != null) { for (var i = 0; i < constraints.length; i++) { if (constraints[i].fieldName == "codigoFormularioPublico" && constraints[i].initialValue != "") { codigoFormularioPublico = constraints[i].initialValue; } if (constraints[i].fieldName == "co" && constraints[i].initialValue != "") { codigoFormularioPublico = constraints[i].initialValue; } if (constraints[i].fieldName == "cj" && constraints[i].initialValue != "") { jornada = constraints[i].initialValue; } } var c1 = DatasetFactory.createConstraint("codigoFormularioPublico", codigoFormularioPublico, codigoFormularioPublico, ConstraintType.MUST), constr = []; constr.push(c1); /*adiciona a restricao da jornada*/ if (jornada != null && jornada != "") { var cCodForm = DatasetFactory.createConstraint("codigoFormularioPublico", codigoFormularioPublico, codigoFormularioPublico, ConstraintType.MUST); var cCodJornada = DatasetFactory.createConstraint("codJornada", jornada, jornada, ConstraintType.MUST); var cActive = DatasetFactory.createConstraint("metadata#active", "true", "true", ConstraintType.MUST); var dsJornada = DatasetFactory.getDataset("dpf_cadastro_jornada", null, [cCodForm,cCodJornada,cActive], null); if (dsJornada != undefined && dsJornada != null && dsJornada.rowsCount > 0) { var documentId = dsJornada.getValue(0, "metadata#id"); var documentVersion = dsJornada.getValue(0, "metadata#version"); var c1 = DatasetFactory.createConstraint("tablename", "tbJornadaStatus", "tbJornadaStatus", ConstraintType.MUST); var c2 = DatasetFactory.createConstraint("metadata#id", documentId, documentId, ConstraintType.MUST); var c3 = DatasetFactory.createConstraint("metadata#version", documentVersion, documentVersion, ConstraintType.MUST); var c4 = DatasetFactory.createConstraint("metadata#active", "true", "true", ConstraintType.MUST); var constrStatus = [c1, c2, c3, c4]; var dsStatusJornada = DatasetFactory.getDataset("dpf_cadastro_jornada", null, constrStatus, ["jornadaOrdem"]); for (var i = 0; i < dsStatusJornada.rowsCount; i++) { var c1 = DatasetFactory.createConstraint("atividadeOrdem", dsStatusJornada.getValue(i,"atividadeOrdem") , dsStatusJornada.getValue(i,"atividadeOrdem") , ConstraintType.SHOULD); var constr = []; constr.push(c1); var dsStatus = DatasetFactory.getDataset("dpf_cadastro_status", null, constr, null); if (dsStatus != null && dsStatus != undefined && dsStatus.rowsCount > 0) { for (var is = 0; is < dsStatus.rowsCount; is++) { var documentId = dsStatus.getValue(is, "metadata#id"); var documentVersion = dsStatus.getValue(is, "metadata#version"); var c1 = DatasetFactory.createConstraint("tablename", "tbAtividade" ,"tbAtividade", ConstraintType.MUST); var c2 = DatasetFactory.createConstraint("metadata#id", documentId, documentId, ConstraintType.MUST); var c3 = DatasetFactory.createConstraint("metadata#version", documentVersion, documentVersion, ConstraintType.MUST); var c4 = DatasetFactory.createConstraint("tipoEtapa", "privado", "privado", ConstraintType.MUST_NOT); var constraintsFilhos = new Array(c1, c2, c3, c4); /*Busca o dataset&*/ var datasetFilhos = DatasetFactory.getDataset("dpf_cadastro_status", null, constraintsFilhos, null); if (datasetFilhos != null && datasetFilhos != undefined && datasetFilhos.rowsCount > 0){ for (var j = 0; j < datasetFilhos.rowsCount; j++) { /*Adiciona os valores nas colunas respectivamente.*/ dataset.addRow(new Array( codigoFormularioPublico, dsStatus.getValue(is,"atividadeOrdem"), datasetFilhos.getValue(j, "atividadeId"), datasetFilhos.getValue(j, "resultadoAtividade"), datasetFilhos.getValue(j, "campo"), dsStatusJornada.getValue(i,"jornadaOrdem") )); } } } } } } } else { var dsStatus = DatasetFactory.getDataset("dpf_cadastro_status", null, constr, ["atividadeOrdem"]); /* Lendo registros filhos */ if (dsStatus != null && dsStatus != undefined && dsStatus.rowsCount > 0) { for (var is = 0; is < dsStatus.rowsCount; is++) { var documentId = dsStatus.getValue(is, "metadata#id"); var documentVersion = dsStatus.getValue(is, "metadata#version"); var c1 = DatasetFactory.createConstraint("tablename", "tbAtividade" ,"tbAtividade", ConstraintType.MUST); var c2 = DatasetFactory.createConstraint("metadata#id", documentId, documentId, ConstraintType.MUST); var c3 = DatasetFactory.createConstraint("metadata#version", documentVersion, documentVersion, ConstraintType.MUST); var c4 = DatasetFactory.createConstraint("tipoEtapa", "privado", "privado", ConstraintType.MUST_NOT); var constraintsFilhos = new Array(c1, c2, c3, c4); /*Busca o dataset&*/ var datasetFilhos = DatasetFactory.getDataset("dpf_cadastro_status", null, constraintsFilhos, null); if (datasetFilhos != null && datasetFilhos != undefined && datasetFilhos.rowsCount > 0){ for (var j = 0; j < datasetFilhos.rowsCount; j++) { /*Adiciona os valores nas colunas respectivamente.*/ dataset.addRow(new Array( codigoFormularioPublico, dsStatus.getValue(is,"atividadeOrdem"), datasetFilhos.getValue(j, "atividadeId"), datasetFilhos.getValue(j, "resultadoAtividade"), datasetFilhos.getValue(j, "campo"), "" )); } } } } else { dataset.addColumn("message"); dataset.addRow(["@@ Código do Formulário Público não encontrado"]); return dataset; } } } else { dataset.addColumn("message"); dataset.addRow(["@@ Formulário não encontrado"]); return dataset; } log.info("Digte Public Form - @@@ Fim Dataset ds_dpf_getListaStatusProcAtiv.js"); return dataset; }